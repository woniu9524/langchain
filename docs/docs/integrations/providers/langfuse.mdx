# Langfuse ğŸª¢

> **ä»€ä¹ˆæ˜¯ Langfuseï¼Ÿ** [Langfuse](https://langfuse.com) æ˜¯ä¸€ä¸ªå¼€æºçš„ LLM å·¥ç¨‹å¹³å°ï¼Œå¯å¸®åŠ©å›¢é˜Ÿè·Ÿè¸ª API è°ƒç”¨ã€ç›‘æ§æ€§èƒ½ä»¥åŠè°ƒè¯•å…¶ AI åº”ç”¨ç¨‹åºä¸­çš„é—®é¢˜ã€‚

## è·Ÿè¸ª LangChain

[Langfuse Tracing](https://langfuse.com/docs/tracing) ä½¿ç”¨ Langchain å›è°ƒæœºåˆ¶ ([Python](https://python.langchain.com/docs/how_to/#callbacks), [JS](https://js.langchain.com/docs/how_to/#callbacks)) ä¸ Langchain é›†æˆã€‚å› æ­¤ï¼ŒLangfuse SDK ä¼šä¸ºæ‚¨çš„ Langchain åº”ç”¨ç¨‹åºçš„æ¯æ¬¡è¿è¡Œè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåµŒå¥—è·Ÿè¸ªã€‚è¿™å…è®¸æ‚¨è®°å½•ã€åˆ†æå’Œè°ƒè¯•æ‚¨çš„ LangChain åº”ç”¨ç¨‹åºã€‚

æ‚¨å¯ä»¥é€šè¿‡ (1) æ„é€ å‡½æ•°å‚æ•°æˆ– (2) ç¯å¢ƒå˜é‡é…ç½®é›†æˆã€‚é€šè¿‡åœ¨ [cloud.langfuse.com](https://cloud.langfuse.com) æ³¨å†Œå¸æˆ·æˆ– [è‡ªæ‰˜ç®¡ Langfuse](https://langfuse.com/self-hosting) æ¥è·å–æ‚¨çš„ Langfuse å‡­è¯ã€‚

### æ„é€ å‡½æ•°å‚æ•°

```python
pip install langfuse
```

```python
from langfuse import Langfuse, get_client
from langfuse.langchain import CallbackHandler
from langchain_openai import ChatOpenAI  # ç¤ºä¾‹ LLM
from langchain_core.prompts import ChatPromptTemplate
 
# ä½¿ç”¨æ„é€ å‡½æ•°å‚æ•°åˆå§‹åŒ– Langfuse å®¢æˆ·ç«¯
Langfuse(
    public_key="your-public-key",
    secret_key="your-secret-key",
    host="https://cloud.langfuse.com"  # å¯é€‰ï¼šé»˜è®¤ä¸º https://cloud.langfuse.com
)
 
# è·å–å·²é…ç½®çš„å®¢æˆ·ç«¯å®ä¾‹
langfuse = get_client()
 
# åˆå§‹åŒ– Langfuse å¤„ç†ç¨‹åº
langfuse_handler = CallbackHandler()
 
# åˆ›å»ºæ‚¨çš„ LangChain ç»„ä»¶
llm = ChatOpenAI(model_name="gpt-4o")
prompt = ChatPromptTemplate.from_template("Tell me a joke about {topic}")
chain = prompt | llm
 
# ä½¿ç”¨ Langfuse è·Ÿè¸ªè¿è¡Œæ‚¨çš„é“¾
response = chain.invoke({"topic": "cats"}, config={"callbacks": [langfuse_handler]})
print(response.content)
 
# åœ¨çŸ­æœŸåº”ç”¨ç¨‹åºä¸­å°†äº‹ä»¶åˆ·æ–°åˆ° Langfuse
langfuse.flush()
```

### ç¯å¢ƒå˜é‡

```bash filename=".env"
LANGFUSE_SECRET_KEY="sk-lf-..."
LANGFUSE_PUBLIC_KEY="pk-lf-..."
# ğŸ‡ªğŸ‡º æ¬§æ´²åœ°åŒºæ•°æ®
LANGFUSE_HOST="https://cloud.langfuse.com"
# ğŸ‡ºğŸ‡¸ ç¾å›½åœ°åŒºæ•°æ®
# LANGFUSE_HOST="https://us.cloud.langfuse.com"
```

```python
# åˆå§‹åŒ– Langfuse å¤„ç†ç¨‹åº
from langfuse.langchain import CallbackHandler
langfuse_handler = CallbackHandler()
 
# æ‚¨çš„ Langchain ä»£ç 
 
# å°† Langfuse å¤„ç†ç¨‹åºæ·»åŠ ä¸ºå›è°ƒï¼ˆç»å…¸å’Œ LCELï¼‰
chain.invoke({"input": "<user_input>"}, config={"callbacks": [langfuse_handler]})
```

è¦äº†è§£å¦‚ä½•å°†æ­¤é›†æˆä¸å…¶ä»– Langfuse åŠŸèƒ½ç»“åˆä½¿ç”¨ï¼Œè¯·æŸ¥çœ‹[æ­¤ç«¯åˆ°ç«¯ç¤ºä¾‹](https://langfuse.com/docs/integrations/langchain/example-python)ã€‚

## è·Ÿè¸ª LangGraph

æœ¬éƒ¨åˆ†å±•ç¤ºäº† [Langfuse](https://langfuse.com/docs) å¦‚ä½•ä½¿ç”¨ [LangChain é›†æˆ](https://langfuse.com/docs/integrations/langchain/tracing) æ¥è°ƒè¯•ã€åˆ†æå’Œè¿­ä»£æ‚¨çš„ LangGraph åº”ç”¨ç¨‹åºã€‚

### åˆå§‹åŒ– Langfuse

**æ³¨æ„ï¼š** æ‚¨éœ€è¦è¿è¡Œè‡³å°‘ Python 3.11 ([GitHub Issue](https://github.com/langfuse/langfuse/issues/1926))ã€‚

ä½¿ç”¨ Langfuse UI ä¸­é¡¹ç›®çš„ [API å¯†é’¥](https://langfuse.com/faq/all/where-are-langfuse-api-keys) åˆå§‹åŒ– Langfuse å®¢æˆ·ç«¯ï¼Œå¹¶å°†å®ƒä»¬æ·»åŠ åˆ°æ‚¨çš„ç¯å¢ƒå˜é‡ä¸­ã€‚


```python
%pip install langfuse
%pip install langchain langgraph langchain_openai langchain_community
```


```python
import os

# ä» https://cloud.langfuse.com è·å–æ‚¨é¡¹ç›®çš„å¯†é’¥
os.environ["LANGFUSE_PUBLIC_KEY"] = "pk-lf-***"
os.environ["LANGFUSE_SECRET_KEY"] = "sk-lf-***"
os.environ["LANGFUSE_HOST"] = "https://cloud.langfuse.com" # æ¬§æ´²æ•°æ®åŒºåŸŸ
# os.environ["LANGFUSE_HOST"] = "https://us.cloud.langfuse.com" # ç¾å›½æ•°æ®åŒºåŸŸ

# æ‚¨çš„ openai å¯†é’¥
os.environ["OPENAI_API_KEY"] = "***"
```

### ä½¿ç”¨ LangGraph çš„ç®€å•èŠå¤©åº”ç”¨

**æœ¬èŠ‚æˆ‘ä»¬å°†åšä»€ä¹ˆï¼š**

*   æ„å»ºä¸€ä¸ªæ”¯æŒèŠå¤©æœºå™¨äººï¼Œèƒ½å¤Ÿå›ç­”å¸¸è§é—®é¢˜
*   ä½¿ç”¨ Langfuse è·Ÿè¸ªèŠå¤©æœºå™¨äººçš„è¾“å…¥å’Œè¾“å‡º

æˆ‘ä»¬å°†ä»ä¸€ä¸ªåŸºç¡€èŠå¤©æœºå™¨äººå¼€å§‹ï¼Œç„¶ååœ¨ä¸‹ä¸€èŠ‚ä¸­æ„å»ºä¸€ä¸ªæ›´é«˜çº§çš„å¤šæ™ºèƒ½ä½“è®¾ç½®ï¼Œé€æ­¥ä»‹ç»å…³é”®çš„ LangGraph æ¦‚å¿µã€‚

#### åˆ›å»º Agent

é¦–å…ˆåˆ›å»ºä¸€ä¸ª `StateGraph`ã€‚`StateGraph` å¯¹è±¡å°†æˆ‘ä»¬çš„èŠå¤©æœºå™¨äººçš„ç»“æ„å®šä¹‰ä¸ºçŠ¶æ€æœºã€‚æˆ‘ä»¬å°†æ·»åŠ èŠ‚ç‚¹æ¥è¡¨ç¤º LLM å’ŒèŠå¤©æœºå™¨äººå¯ä»¥è°ƒç”¨çš„å‡½æ•°ï¼Œå¹¶æ·»åŠ è¾¹æ¥æŒ‡å®šæœºå™¨äººå¦‚ä½•åœ¨è¿™äº›å‡½æ•°ä¹‹é—´è½¬æ¢ã€‚


```python
from typing import Annotated

from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage
from typing_extensions import TypedDict

from langgraph.graph import StateGraph
from langgraph.graph.message import add_messages

class State(TypedDict):
    # Messages çš„ç±»å‹ä¸ºâ€œlistâ€ã€‚æ³¨é‡Šä¸­çš„ `add_messages` å‡½æ•°å®šä¹‰äº†æ­¤çŠ¶æ€é”®åº”å¦‚ä½•æ›´æ–°
    # ï¼ˆåœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œå®ƒä¼šå°†æ¶ˆæ¯é™„åŠ åˆ°åˆ—è¡¨ä¸­ï¼Œè€Œä¸æ˜¯è¦†ç›–å®ƒä»¬ï¼‰
    messages: Annotated[list, add_messages]

graph_builder = StateGraph(State)

llm = ChatOpenAI(model = "gpt-4o", temperature = 0.2)

# chatbot èŠ‚ç‚¹å‡½æ•°æ¥æ”¶å½“å‰çŠ¶æ€ä½œä¸ºè¾“å…¥å¹¶è¿”å›æ›´æ–°åçš„æ¶ˆæ¯åˆ—è¡¨ã€‚è¿™æ˜¯æ‰€æœ‰ LangGraph èŠ‚ç‚¹å‡½æ•°çš„æ¨¡å¼ã€‚
def chatbot(state: State):
    return {"messages": [llm.invoke(state["messages"])]}

# æ·»åŠ ä¸€ä¸ªâ€œchatbotâ€èŠ‚ç‚¹ã€‚èŠ‚ç‚¹ä»£è¡¨å·¥ä½œå•å…ƒã€‚å®ƒä»¬é€šå¸¸æ˜¯å¸¸è§„çš„ Python å‡½æ•°ã€‚
graph_builder.add_node("chatbot", chatbot)

# æ·»åŠ ä¸€ä¸ªå…¥å£ç‚¹ã€‚è¿™å‘Šè¯‰æˆ‘ä»¬çš„å›¾æ¯æ¬¡è¿è¡Œå›¾æ—¶ä»å“ªé‡Œå¼€å§‹å·¥ä½œã€‚
graph_builder.set_entry_point("chatbot")

# è®¾ç½®ä¸€ä¸ªå®Œæˆç‚¹ã€‚è¿™æŒ‡ç¤ºå›¾â€œä»»ä½•æ—¶å€™è¿è¡Œæ­¤èŠ‚ç‚¹ï¼Œæ‚¨éƒ½å¯ä»¥é€€å‡ºã€‚â€
graph_builder.set_finish_point("chatbot")

# ä¸ºäº†èƒ½å¤Ÿè¿è¡Œæˆ‘ä»¬çš„å›¾ï¼Œè¯·è°ƒç”¨å›¾æ„å»ºå™¨ä¸Šçš„â€œcompile()â€ã€‚è¿™å°†åˆ›å»ºä¸€ä¸ªæˆ‘ä»¬å¯ä»¥ç”¨äºåœ¨çŠ¶æ€ä¸Šè°ƒç”¨ `invoke` çš„â€œCompiledGraphâ€ã€‚
graph = graph_builder.compile()
```

#### å°† Langfuse æ·»åŠ ä¸ºè°ƒç”¨çš„å›è°ƒ

ç°åœ¨ï¼Œæˆ‘ä»¬å°†æ·»åŠ  [LangChain çš„ Langfuse å›è°ƒå¤„ç†ç¨‹åº](https://langfuse.com/docs/integrations/langchain/tracing) æ¥è·Ÿè¸ªæˆ‘ä»¬åº”ç”¨ç¨‹åºçš„æ­¥éª¤ï¼š`config={"callbacks": [langfuse_handler]}`


```python
from langfuse.langchain import CallbackHandler

# åˆå§‹åŒ– Langchain çš„ Langfuse CallbackHandler (ç”¨äºè·Ÿè¸ª)
langfuse_handler = CallbackHandler()

for s in graph.stream({"messages": [HumanMessage(content = "What is Langfuse?")]},
                      config={"callbacks": [langfuse_handler]}):
    print(s)
```

```
{'chatbot': {'messages': [AIMessage(content='Langfuse is a tool designed to help developers monitor and observe the performance of their Large Language Model (LLM) applications. It provides detailed insights into how these applications are functioning, allowing for better debugging, optimization, and overall management. Langfuse offers features such as tracking key metrics, visualizing data, and identifying potential issues in real-time, making it easier for developers to maintain and improve their LLM-based solutions.', response_metadata={'token_usage': {'completion_tokens': 86, 'prompt_tokens': 13, 'total_tokens': 99}, 'model_name': 'gpt-4o-2024-05-13', 'system_fingerprint': 'fp_400f27fa1f', 'finish_reason': 'stop', 'logprobs': None}, id='run-9a0c97cb-ccfe-463e-902c-5a5900b796b4-0', usage_metadata={'input_tokens': 13, 'output_tokens': 86, 'total_tokens': 99})]}}
```


#### åœ¨ Langfuse ä¸­æŸ¥çœ‹è·Ÿè¸ª

Langfuse ä¸­çš„ç¤ºä¾‹è·Ÿè¸ªï¼šhttps://cloud.langfuse.com/project/cloramnkj0002jz088vzn1ja4/traces/d109e148-d188-4d6e-823f-aac0864afbab

![Langfuse ä¸­èŠå¤©åº”ç”¨çš„è·Ÿè¸ªè§†å›¾](https://langfuse.com/images/cookbook/integration-langgraph/integration_langgraph_chatapp_trace.png)

- æŸ¥çœ‹[å®Œæ•´çš„ Notebook](https://langfuse.com/docs/integrations/langchain/example-python-langgraph) ä»¥æŸ¥çœ‹æ›´å¤šç¤ºä¾‹ã€‚
- è¦äº†è§£å¦‚ä½•è¯„ä¼°æ‚¨çš„ LangGraph åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œè¯·æŸ¥çœ‹[LangGraph è¯„ä¼°æŒ‡å—](https://langfuse.com/docs/integrations/langchain/example-langgraph-agents)ã€‚